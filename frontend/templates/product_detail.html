<!DOCTYPE html>
<html lang="en">

<head>
    <meta charset="UTF-8">
    <meta name="viewport" content="width=device-width, initial-scale=1.0">
    <title>{{ product.name }}</title>
    <script src="https://cdn.tailwindcss.com"></script>
    <style>
        .thumb {
            width: 64px;
            height: 64px;
        }

        .main-media {
            height: 420px;
        }
    </style>
</head>

<body class="min-h-screen bg-gray-50">

    <!-- Header (kept consistent) -->
    <header class="bg-white border-b sticky top-0 z-50">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8">
            <div class="flex items-center justify-between h-16">
                <div class="flex items-center gap-6">
                    <a href="{{ url_for('product.list_products') }}"
                        class="text-2xl font-bold text-indigo-600">MyShop</a>
                </div>

                <div class="flex-1 px-4">
                    <div class="max-w-2xl mx-auto">
                        <form id="header-search-form" class="relative">
                            <input id="search-input" name="q" value="{{ request.args.get('q', '') }}"
                                placeholder="Search products, brands, categories"
                                class="w-full border border-gray-200 rounded-full py-3 px-4 pl-10 shadow-sm focus:outline-none focus:ring-2 focus:ring-indigo-200" />
                            <svg class="w-5 h-5 text-gray-400 absolute left-3 top-3.5" aria-hidden="true"
                                xmlns="http://www.w3.org/2000/svg" fill="none" viewBox="0 0 24 24"
                                stroke="currentColor">
                                <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2"
                                    d="M21 21l-4.35-4.35M11 19a8 8 0 100-16 8 8 0 000 16z" />
                            </svg>
                        </form>
                    </div>
                </div>

                <div class="flex items-center gap-4">
                    <a href="{{ url_for('order.view_my_orders') }}"
                        class="text-sm text-gray-600 hover:text-gray-800">Orders</a>
                    <a href="{{ url_for('cart.view_cart') }}"
                        class="relative inline-flex items-center px-3 py-2 rounded-md text-sm text-gray-700 hover:bg-gray-50">Cart
                        {% if session.get('cart_count') %}
                        <span
                            class="ml-2 inline-flex items-center justify-center px-2 py-0.5 text-xs font-bold leading-none text-white bg-red-500 rounded-full">{{
                            session.get('cart_count') }}</span>
                        {% endif %}
                    </a>
                </div>
            </div>
        </div>
    </header>

    <main class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-10">
        <div class="grid grid-cols-1 lg:grid-cols-12 gap-8">
            <!-- Gallery -->
            <div class="lg:col-span-7 bg-white rounded-lg p-6 shadow-sm">
                <div class="mb-4">
                    <div id="mainImage"
                        class="bg-gray-100 rounded-lg overflow-hidden main-media flex items-center justify-center">
                        {% if product.image_url %}
                        <img id="current-image" src="{{ product.image_url }}" alt="{{ product.name }}"
                            class="w-full h-full object-cover">
                        {% else %}
                        <div class="text-gray-400">No Image</div>
                        {% endif %}
                    </div>
                </div>

                <div class="flex gap-3">
                    <!-- Thumbnails: if product.images available, iterate, otherwise show single thumb -->
                    {% if product.images %}
                    {% for img in product.images %}
                    <button type="button" data-src="{{ img }}"
                        class="thumb p-0 rounded-md overflow-hidden border border-gray-200">
                        <img src="{{ img }}" alt="thumb" class="w-full h-full object-cover">
                    </button>
                    {% endfor %}
                    {% else %}
                    {% if product.image_url %}
                    <div class="thumb p-0 rounded-md overflow-hidden border border-gray-200">
                        <img src="{{ product.image_url }}" alt="thumb" class="w-full h-full object-cover">
                    </div>
                    {% endif %}
                    {% endif %}
                </div>
            </div>

            <!-- Details -->
            <aside class="lg:col-span-5 bg-white rounded-lg p-6 shadow-sm flex flex-col justify-between">
                <div>
                    <h1 class="text-2xl font-extrabold text-gray-900">{{ product.name }}</h1>
                    <div class="mt-2 flex items-center gap-3">
                        {% if product.category %}
                        <span class="text-sm text-gray-500">{{ product.category }}</span>
                        {% endif %}
                        <div class="ml-auto text-sm text-gray-600">ID: {{ product.id }}</div>
                    </div>

                    <div class="mt-4 flex items-baseline gap-4">
                        <div class="text-3xl font-bold text-indigo-600">${{ "%.2f"|format(product.price|float) }}</div>
                        {% if product.old_price %}
                        <div class="text-sm text-gray-400 line-through">${{ "%.2f"|format(product.old_price|float) }}
                        </div>
                        {% endif %}
                    </div>

                    <div class="mt-4 text-gray-700">{{ product.description or 'No description available.' }}</div>

                    <div class="mt-6 grid grid-cols-3 gap-3 items-center">
                        <div class="col-span-2 flex items-center gap-3">
                            <div class="flex items-center border rounded-md overflow-hidden">
                                <button id="qty-decrease" type="button" class="px-3 py-2 text-gray-600">−</button>
                                <input id="qty-input" type="number" min="1" value="1"
                                    class="w-16 text-center border-l border-r py-2" />
                                <button id="qty-increase" type="button" class="px-3 py-2 text-gray-600">+</button>
                            </div>
                            {% if product.stock > 0 %}
                            <div class="text-sm text-green-600">In stock</div>
                            {% else %}
                            <div class="text-sm text-red-600">Out of stock</div>
                            {% endif %}
                        </div>

                        <div class="col-span-1">
                            {% if product.stock > 0 %}
                            <form method="POST" action="{{ url_for('cart.add_to_cart', product_id=product.id) }}"
                                id="addCartForm">
                                <input type="hidden" name="quantity" id="form-quantity" value="1" />
                                <button type="submit"
                                    class="w-full py-2 rounded-md bg-indigo-600 text-white font-semibold">Add to
                                    Cart</button>
                            </form>
                            {% else %}
                            <button disabled
                                class="w-full py-2 rounded-md bg-gray-200 text-gray-500">Unavailable</button>
                            {% endif %}
                        </div>
                    </div>
                </div>

                <div class="mt-6">
                    <h4 class="text-sm font-medium">Details</h4>
                    <ul class="mt-2 text-sm text-gray-600 list-disc list-inside">
                        <li>Category: {{ product.category or '—' }}</li>
                        <li>SKU: {{ product.sku or product.id }}</li>
                        <li>Shipping: Calculated at checkout</li>
                    </ul>
                </div>
            </aside>
        </div>
    </main>

    <footer class="mt-auto bg-white border-t">
        <div class="max-w-7xl mx-auto px-4 sm:px-6 lg:px-8 py-6 text-sm text-gray-600">© {{ current_year or "2026" }}
            MyShop — Built with care.</div>
    </footer>

    <script>
        // Thumbnail swap and quantity handling
        document.addEventListener('DOMContentLoaded', function () {
            const thumbs = Array.from(document.querySelectorAll('[data-src]'));
            const current = document.getElementById('current-image');
            thumbs.forEach(t => t.addEventListener('click', function () {
                const src = this.dataset.src;
                if (current && src) current.src = src;
            }));

            const qtyInput = document.getElementById('qty-input');
            const qtyDec = document.getElementById('qty-decrease');
            const qtyInc = document.getElementById('qty-increase');
            const formQty = document.getElementById('form-quantity');

            function setQty(v) {
                v = Math.max(1, Math.floor(v));
                qtyInput.value = v;
                if (formQty) formQty.value = v;
            }

            if (qtyDec) qtyDec.addEventListener('click', function () { setQty(Number(qtyInput.value || 1) - 1); });
            if (qtyInc) qtyInc.addEventListener('click', function () { setQty(Number(qtyInput.value || 1) + 1); });
            if (qtyInput) qtyInput.addEventListener('change', function () { setQty(Number(qtyInput.value || 1)); });

            // Submit handler: call add-to-cart endpoint `quantity` times (sequentially)
            const addCartForm = document.getElementById('addCartForm');
            if (addCartForm) {
                addCartForm.addEventListener('submit', async function (e) {
                    e.preventDefault();
                    if (addCartForm.dataset.submitting === '1') return;
                    addCartForm.dataset.submitting = '1';
                    const submitBtn = addCartForm.querySelector('button[type="submit"]');
                    if (submitBtn) {
                        submitBtn.disabled = true;
                        submitBtn.classList.add('opacity-50', 'cursor-not-allowed');
                    }

                    // determine requested quantity (fall back to 1)
                    let qty = 1;
                    const formQty = document.getElementById('form-quantity');
                    if (formQty) qty = Math.max(1, parseInt(formQty.value) || 1);
                    else if (qtyInput) qty = Math.max(1, parseInt(qtyInput.value) || 1);

                    const action = addCartForm.getAttribute('action') || window.location.href;
                    const returnUrl = "{{ url_for('cart.view_cart') }}";

                    try {
                        for (let i = 0; i < qty; i++) {
                            if (submitBtn) submitBtn.textContent = `Adding (${i + 1}/${qty})...`;
                            const res = await fetch(action, {
                                method: 'POST',
                                credentials: 'same-origin',
                                headers: { 'Content-Type': 'application/x-www-form-urlencoded' },
                                body: new URLSearchParams({ quantity: '1' })
                            });
                            if (!res.ok) {
                                console.error('Add to cart failed', res.status);
                                break;
                            }
                        }
                    } catch (err) {
                        console.error(err);
                    }

                    // after attempts, go to cart
                    window.location.href = returnUrl;
                });
            }
        });
    </script>

</body>

</html>